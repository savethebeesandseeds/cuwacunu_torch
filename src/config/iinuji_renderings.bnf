; ============================================================
; iinuji visualization DSL â€“ BASIC BNF specification (v0.3-basic)
;
; Goals of this version:
;   - Keep grammar simple for our in-house BNF engine.
;   - Avoid complex EBNF groups like: [ {<x>} ] or nested constructs.
;   - Avoid "long alternatives" inside a single rule; factor them out.
;
; Comments:
;   - ONLY full-line comments are allowed.
;   - A comment line starts with optional whitespace, then ';', then any text.
;   - Inline/end-of-line comments are NOT part of the grammar by design.
;
; Empty lines:
;   - Allowed anywhere a "*_line" occurs.
; ============================================================


; ---------- Top level ------------------------------------------------
; The file can contain:
;   - one or more SCREEN blocks
;   - blank lines
;   - comment lines
;
; If you want to allow a file with no SCREEN, wrap <instruction_items> in an opt.
; (Runtime validation can enforce "at least one SCREEN".)

<instruction> ::= <instruction_items_opt> ;

<instruction_items_opt> ::= [<instruction_items>] ;
<instruction_items> ::= {<instruction_item>} ;

<instruction_item> ::= <screen>
                     | <blank_line>
                     | <comment_line>
                     ;


; ---------- Common line types ----------------------------------------

<blank_line> ::= <ws0> <lb> ;

<comment_line> ::= <ws0> ";" <comment_text_opt> <lb> ;
<comment_text_opt> ::= [<comment_text>] ;
<comment_text> ::= {<comment_char>} ;

; Keep comment chars permissive (no newline).
; If this proves too strict, just broaden it later.
<comment_char> ::= <alpha>
                 | <digit>
                 | <hsp>
                 | "_" | "-" | "." | ":" | "," | "#" | "+" | "/" | "(" | ")"
                 | "[" | "]" | "{" | "}" | "<" | ">" | "=" | "*" | "!" | "?"
                 ;


; ---------- Screens --------------------------------------------------

<screen> ::= "SCREEN" <ws1> <screen_type> <ws0> <lb>
             <screen_lines_opt>
             <ws0> "ENDSCREEN" ;

<screen_type> ::= "_screen" ;

<screen_lines_opt> ::= [<screen_lines>] ;
<screen_lines> ::= {<screen_line>} ;

<screen_line> ::= <screen_stmt_line>
                | <blank_line>
                | <comment_line>
                ;

; factor the "long alternative" into its own rule
<screen_stmt_line> ::= <screen_stmt_line_long> ;
<screen_stmt_line_long> ::= <ws0> <screen_stmt> <ws0> <lb> ;

<screen_stmt> ::= <screen_prop>
                | <panel_stmt>
                | <event_block>
                ;


; ---------- Screen properties ----------------------------------------

<screen_prop> ::= <opt_name>
                | <opt_key>
                | <opt_line_color>
                | <opt_text_color>
                | <opt_back_color>
                | <opt_tickness>
                ;


; ---------- Panels ---------------------------------------------------

<panel_stmt> ::= "PANEL" <ws1> <panel_type> <ws0> <lb>
                 <panel_lines_opt>
                 <ws0> "ENDPANEL" ;

<panel_type> ::= "_rectangle" ;

<panel_lines_opt> ::= [<panel_lines>] ;
<panel_lines> ::= {<panel_line>} ;

<panel_line> ::= <panel_stmt_line>
               | <blank_line>
               | <comment_line>
               ;

; factor the long alternative
<panel_stmt_line> ::= <panel_stmt_line_long> ;
<panel_stmt_line_long> ::= <ws0> <panel_stmt_item> <ws0> <lb> ;

<panel_stmt_item> ::= <panel_prop>
                    | <figure_stmt>
                    ;


; ---------- Panel properties -----------------------------------------

<panel_prop> ::= <opt_coords>
               | <opt_shape>
               | <opt_z_index>
               | <opt_title>
               | <opt_border>
               | <opt_line_color>
               | <opt_text_color>
               | <opt_back_color>
               | <opt_tickness>
               ;


; ---------- Figures --------------------------------------------------

<figure_stmt> ::= "FIGURE" <ws1> <figure_kind> <ws0> <lb>
                  <figure_lines_opt>
                  <ws0> "ENDFIGURE" ;

<figure_kind> ::= "_label"
                | "_horizontal_plot"
                | "_input_box"
                | "_buffer"
                ;

<figure_lines_opt> ::= [<figure_lines>] ;
<figure_lines> ::= {<figure_line>} ;

<figure_line> ::= <figure_prop_line>
                | <blank_line>
                | <comment_line>
                ;

; factor the long alternative
<figure_prop_line> ::= <figure_prop_line_long> ;
<figure_prop_line_long> ::= <ws0> <figure_prop> <ws0> <lb> ;

<figure_prop> ::= <opt_coords>
                | <opt_shape>
                | <opt_value>
                | <opt__capacity>
                | <opt_title>
                | <opt_legend>
                | <opt_type>
                | <opt_border>
                | <opt_tickness>
                | <opt_line_color>
                | <opt_text_color>
                | <opt_back_color>
                | <opt_triggers>
                ;


; ---------- Trigger lists --------------------------------------------

<trigger_list> ::= <event_name> <trigger_list_tail_opt> ;
<trigger_list_tail_opt> ::= [<trigger_list_tail>] ;
<trigger_list_tail> ::= {<trigger_list_tail_item>} ;
<trigger_list_tail_item> ::= <ws0> "," <ws0> <event_name> ;

<event_name> ::= <name_ident> ;


; ---------- Events ---------------------------------------------------

<event_block> ::= "EVENT" <ws1> <event_kind> <ws0> <lb>
                  <event_lines_opt>
                  <ws0> "ENDEVENT" ;

<event_kind> ::= "_update" | "_action" ;

<event_lines_opt> ::= [<event_lines>] ;
<event_lines> ::= {<event_line>} ;

<event_line> ::= <event_prop_line>
               | <blank_line>
               | <comment_line>
               ;

; factor the long alternative
<event_prop_line> ::= <event_prop_line_long> ;
<event_prop_line_long> ::= <ws0> <event_prop> <ws0> <lb> ;

<event_prop> ::= <opt_name>
               | <opt_form>
               ;


; ---------- Event form specification ---------------------------------

<opt_form> ::= "__form" <ws1> <form_spec> ;

<form_spec> ::= <form_binding> <form_spec_tail_opt> ;
<form_spec_tail_opt> ::= [<form_spec_tail>] ;
<form_spec_tail> ::= {<form_spec_tail_item>} ;
<form_spec_tail_item> ::= <ws0> "," <form_binding> ;

<form_binding> ::= <ws0> <name_ident> ":." <name_ident> <ws0> ;


; ---------- Shared structures ----------------------------------------

<fcode> ::= "F" "+" <int> ;

<point> ::= <int> <ws0> "," <ws0> <int> ;


; ---------- Shared fields --------------------------------------------

<opt_name>       ::= "__name"       <ws1> <name_ident>             ;
<opt_key>        ::= "__key"        <ws1> <fcode>                  ;
<opt_line_color> ::= "__line_color" <ws1> <color_hex>              ;
<opt_text_color> ::= "__text_color" <ws1> <color_hex>              ;
<opt_back_color> ::= "__back_color" <ws1> <color_hex>              ;
<opt_tickness>   ::= "__tickness"   <ws1> <number>                 ;
<opt_coords>     ::= "__coords"     <ws1> <point>                  ;
<opt_shape>      ::= "__shape"      <ws1> <point>                  ;
<opt__capacity>  ::= "__capacity"   <ws1> <number>                 ;
<opt_z_index>    ::= "__z_index"    <ws1> <int>                    ;
<opt_title>      ::= "__title"      <ws1> <bool> <ws1> <dq_string> ;
<opt_border>     ::= "__border"     <ws1> <bool>                   ;
<opt_value>      ::= "__value"      <ws1> <dq_string>              ;
<opt_legend>     ::= "__legend"     <ws1> <bool> <ws1> <dq_string> ;
<opt_type>       ::= "__type"       <ws1> <name_ident>             ;
<opt_triggers>   ::= "__triggers"   <ws1> <trigger_list>           ;


; ---------- Basic lexical elements -----------------------------------

<bool> ::= "true" | "false" ;

; Keep this form: it's what your current engine + existing DSL already uses.
<int> ::= {<digit>} ;

<number> ::= <int> <number_frac_opt> ;
<number_frac_opt> ::= [<number_frac>] ;
<number_frac> ::= "." <int> ;

<color_hex> ::= "#" <hexdigit> <hexdigit> <hexdigit>
                    <hexdigit> <hexdigit> <hexdigit> ;

<hexdigit> ::= <digit>
             | "a" | "b" | "c" | "d" | "e" | "f"
             | "A" | "B" | "C" | "D" | "E" | "F" ;

<digit> ::= "0" | "1" | "2" | "3" | "4" | "5" | "6" | "7" | "8" | "9" ;

<upper> ::= "A" | "B" | "C" | "D" | "E" | "F" | "G" | "H" | "I" | "J"
          | "K" | "L" | "M" | "N" | "O" | "P" | "Q" | "R" | "S" | "T"
          | "U" | "V" | "W" | "X" | "Y" | "Z" ;

<lower> ::= "a" | "b" | "c" | "d" | "e" | "f" | "g" | "h" | "i" | "j"
          | "k" | "l" | "m" | "n" | "o" | "p" | "q" | "r" | "s" | "t"
          | "u" | "v" | "w" | "x" | "y" | "z" ;

<alpha> ::= <upper> | <lower> ;

<name_ident> ::= <alpha> <name_tail_opt> ;
<name_tail_opt> ::= [<name_tail>] ;
<name_tail> ::= {<id_tail>} ;
<id_tail> ::= <alpha> | <digit> | "_" | "-" | "." ;


; ---------- Strings --------------------------------------------------

<dq_string> ::= "\"" <dq_payload_opt> "\"" ;
<dq_payload_opt> ::= [<dq_payload>] ;
<dq_payload> ::= {<dq_char>} ;

<dq_char> ::= <alpha> | <digit> | "_" | "-" | "." | ":" | "," | "#" | "+"
            | "/" | "(" | ")" | " " ;


; ---------- Whitespace tokens ---------------------------------------

<hsp> ::= " " | "\t" ;

<ws1> ::= {<hsp>} ;
<ws0> ::= [<ws1>] ;

<lb> ::= "\r\n" | "\n" ;
